# --- 2. ChromaDB Manager ---

from typing import List


class ChromaDBManager:
    """Управляет векторной базой данных ChromaDB для контекста."""
    def __init__(self, path="./chroma_db"):
        self.client = chromadb.PersistentClient(path=path)
        self.collection = self.client.get_or_create_collection(name="shonen_inspiration")
        self._initialize_data()

    def _initialize_data(self):
        """Инициализирует базу данных примерами вдохновения."""
        if self.collection.count() == 0:
            texts = [
                "Темы сёнэна: сила дружбы, преодоление себя, становление сильнее, вера в свои идеалы, честность с собой и другими [1-8].",
                "Развитие персонажей: герой растет физически и ментально, осознает свои слабости и принимает их, преодолевает травмы, учится ответственности. Пример Наруто, Элрик из Стального Алхимика, Моб из Моб Психо 100 [5, 8-13].",
                "Магические системы: четкие правила, ограниченные способности, стратегический потенциал (Наруто, Hunter x Hunter). Или простые, работающие на раскрытие темы (One Piece, Frieren). Или псевдонаучные (Стальной Алхимик) [3, 4, 14-16].",
                "Гендерные темы: Важность самодостаточных женских персонажей, не зависящих от романтического интереса (One Piece, Frieren). Критика плоских женских персонажей (Наруто, Demon Slayer, My Hero Academia) [17-21].",
                "Конфликт в диалогах: диалог как 'пин-понг', раскрытие характера через речь, конфликт интересов [22, 23].",
                "Юмор: заход (реальная часть) и добивка (вымышленная, гиперболизированная часть) [24-26].",
                "Сюжетные повороты: неожиданные события, меняющие ход истории (Атака Титанов, Звездные Войны) [23, 27, 28].",
                "Типология Проппа: устойчивые элементы сказки, следующие в строгой последовательности для построения сюжета [29-31].",
                "Проблема современных сёнэнов: самоповтор, отсутствие авторской индивидуальности, угождение редакции и фанатам. Важность вдохновения из других сфер, не только сёнэнов [32-34].",
                "Пример сильного героя: Кэнсиро из Кулака Северной Звезды — суперсильный с первой серии, но его легендарность выходит боком, он часто не успевает помочь нуждающимся [35].",
                "Пример героя-ребенка: Гон из Хантера, эмоциональный и эгоистичный, в отличие от рационального Килуа [36].",
                "Пример мужества и потерь: Кулак Северной Звезды — история о том, как остаться человеком в жестоком мире [37].",
                "Пример взросления через дружбу и семью: Отчет о буйстве духов, Драгонболл [1, 38].",
                "Пример команды: One Piece, важность каждого члена команды, вместе сильнее [4].",
                "Пример 'не тот, кем кажется': Кувабара, Хей, Курама из Отчета о буйстве духов — изначально 'злодеи', меняющиеся через дружбу [37].",
                "Пример цинизма: Атака Титанов — герой становится циничным из-за непроработанных травм [39].",
                "Пример истинного взросления: Моб из Моб Психо 100 — сила не решает проблемы, а мешает взрослению; взросление через самопонимание и принятие себя [8, 13, 40]."
            ]
            ids = [f"doc{i}" for i in range(len(texts))]
            self.collection.add(documents=texts, ids=ids)
            print("ChromaDB инициализирована данными.")

    def query(self, query_text: str, n_results: int = 3) -> List[str]:
        """Выполняет поиск релевантных документов."""
        results = self.collection.query(query_texts=[query_text], n_results=n_results)
        return results['documents'] if results['documents'] else []